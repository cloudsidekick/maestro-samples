{
    "Code": "petclinic 100",
    "Codeblocks": [
        {
            "Name": "getinstancestatus",
            "Steps": [
                {
                    "Codeblock": "getinstancestatus",
                    "Commented": false,
                    "Description": "describe the instance",
                    "FunctionName": "aws_ec2_DescribeInstances",
                    "FunctionXML": "<function name=\"aws_ec2_DescribeInstances\">\n                            <aws_region class=\"combo w300px\" dataset=\"ddDataSource_GetAWSClouds\" datasource=\"function\" hr_after=\"true\" input_type=\"dropdown\" label=\"AWS Region\" />\n                            <InstanceId.n is_array=\"true\">\n                                <InstanceId input_type=\"text\">[[instance]]</InstanceId>\n                            </InstanceId.n>\n                            <Filter.n is_array=\"true\">\n                                <Filter>\n                                    <Name input_type=\"text\" />\n                                    <Value.m is_array=\"true\">\n                                        <Value input_type=\"text\" />\n                                    </Value.m>\n                                </Filter>\n                            </Filter.n>\n                            <result_name break_before=\"true\" input_type=\"text\" label=\"Result Variable\">r</result_name>\n                        </function>",
                    "IsValid": true,
                    "Locked": false,
                    "Order": 1,
                    "OutputColumnDelimiter": 0,
                    "OutputParseType": 0,
                    "OutputRowDelimiter": 0,
                    "ValueSnip": null,
                    "XPathPrefix": ""
                },
                {
                    "Codeblock": "getinstancestatus",
                    "Commented": false,
                    "Description": "extract the state and external dns from the xml",
                    "FunctionName": "set_variable",
                    "FunctionXML": "<function name=\"set_variable\">\n                            <variables label=\"Variables\">\n                                <variable label=\"Variable\">\n                                    <name input_type=\"text\" label=\"Name\">state</name>\n                                    <value input_type=\"text\" label=\"Value\">[[r.//instanceState/name]]</value>\n                                    <modifier input_type=\"select\" label=\"Modifier\">DEFAULT</modifier>\n                                </variable>\n                                <variable label=\"Variable\">\n                                    <name input_type=\"text\" label=\"Name\">dnsname</name>\n                                    <value input_type=\"text\" label=\"Value\">[[r.//dnsName]]</value>\n                                    <modifier input_type=\"select\" label=\"Modifier\">DEFAULT</modifier>\n                                </variable>\n                            </variables>\n                        </function>",
                    "IsValid": true,
                    "Locked": false,
                    "Order": 2,
                    "OutputColumnDelimiter": 0,
                    "OutputParseType": 0,
                    "OutputRowDelimiter": 0,
                    "ValueSnip": null,
                    "XPathPrefix": ""
                },
                {
                    "Codeblock": "getinstancestatus",
                    "Commented": false,
                    "Description": "test to see if the instance is running, if not sleep",
                    "FunctionName": "if",
                    "FunctionXML": "<function name=\"if\">\n                            <tests>\n                                <test>\n                                    <eval>\"[[state]]\" == \"running\"</eval>\n                                    <action>\n                                        <function name=\"break_loop\" />\n                                    </action>\n                                </test>\n                            </tests>\n                            <else input_type=\"text\">\n                                <function name=\"sleep\" snip=\"seconds\">\n                                    <seconds input_type=\"text\" label=\"Sleep\">[[sleep_secs]]</seconds>\n                                </function>\n                            </else>\n                        </function>",
                    "IsValid": true,
                    "Locked": false,
                    "Order": 3,
                    "OutputColumnDelimiter": 0,
                    "OutputParseType": 0,
                    "OutputRowDelimiter": 0,
                    "ValueSnip": null,
                    "XPathPrefix": ""
                }
            ]
        },
        {
            "Name": "MAIN",
            "Steps": [
                {
                    "Codeblock": "MAIN",
                    "Commented": false,
                    "Description": "get global values from service datastore",
                    "FunctionName": "get_deployment_value",
                    "FunctionXML": "<function extension=\"maestro.datastore\" name=\"get_deployment_value\">\n                            <scope dataset=\"Deployment|Service\" datasource=\"local\" input_type=\"dropdown\" label=\"Scope\">Service</scope>\n                            <pairs is_array=\"true\" label=\"Key Value Pairs\">\n                                <pair label=\"Pair\">\n                                    <key input_type=\"text\" label=\"Key\">image</key>\n                                    <variable_name input_type=\"text\" label=\"Variable\" required=\"true\">image</variable_name>\n                                </pair>\n                            <pair label=\"Pair\">\n\t\t\t\t\t\t\t<key input_type=\"text\" label=\"Key\">security_group</key>\n\t\t\t\t\t\t\t<variable_name input_type=\"text\" label=\"Variable\" required=\"true\">sg</variable_name>\n\t\t\t\t\t\t</pair><pair label=\"Pair\">\n\t\t\t\t\t\t\t<key input_type=\"text\" label=\"Key\">type</key>\n\t\t\t\t\t\t\t<variable_name input_type=\"text\" label=\"Variable\" required=\"true\">type</variable_name>\n\t\t\t\t\t\t</pair></pairs>\n                        </function>",
                    "IsValid": true,
                    "Locked": false,
                    "Order": 1,
                    "OutputColumnDelimiter": 0,
                    "OutputParseType": 0,
                    "OutputRowDelimiter": 0,
                    "ValueSnip": null,
                    "XPathPrefix": ""
                },
                {
                    "Codeblock": "MAIN",
                    "Commented": false,
                    "Description": "get global values from deployment datastore",
                    "FunctionName": "get_deployment_value",
                    "FunctionXML": "<function extension=\"maestro.datastore\" name=\"get_deployment_value\">\n\t\t\t\t\t<scope dataset=\"Deployment|Service\" datasource=\"local\" input_type=\"dropdown\" label=\"Scope\">Deployment</scope>\n\t\t\t\t\t<pairs is_array=\"true\" label=\"Key Value Pairs\">\n\t\t\t\t\t\t<pair label=\"Pair\">\n\t\t\t\t\t\t\t<key input_type=\"text\" label=\"Key\">keyname</key>\n\t\t\t\t\t\t\t<variable_name input_type=\"text\" label=\"Variable\" required=\"true\">key</variable_name>\n\t\t\t\t\t\t</pair>\n\t\t\t\t\t</pairs>\n\t\t\t\t</function>",
                    "IsValid": true,
                    "Locked": false,
                    "Order": 2,
                    "OutputColumnDelimiter": 0,
                    "OutputParseType": 0,
                    "OutputRowDelimiter": 0,
                    "ValueSnip": null,
                    "XPathPrefix": ""
                },
                {
                    "Codeblock": "MAIN",
                    "Commented": false,
                    "Description": "create the ec2 instance",
                    "FunctionName": "aws_ec2_RunInstances",
                    "FunctionXML": "<function name=\"aws_ec2_RunInstances\">\n\t\t\t\t\t\t<aws_region class=\"combo w300px\" dataset=\"ddDataSource_GetAWSClouds\" datasource=\"function\" input_type=\"dropdown\" label=\"AWS Region\" />\n\t\t\t\t\t\t<result_name hr_after=\"true\" input_type=\"text\" label=\"Result Variable\">result</result_name>\n\t\t\t\t\t\t<ImageId input_type=\"text\">[[image]]</ImageId>\n\t\t\t\t\t\t<MinCount input_type=\"text\">1</MinCount>\n\t\t\t\t\t\t<MaxCount input_type=\"text\">1</MaxCount>\n\t\t\t\t\t\t<KeyName break_before=\"true\" input_type=\"text\">[[key]]</KeyName>\n\t\t\t\t\t\t<InstanceType input_type=\"text\">[[type]]</InstanceType>\n\t\t\t\t\t\t<UserData break_after=\"true\" break_before=\"true\" input_type=\"textarea\" rows=\"2\" style=\"width: 95%\" />\n\t\t\t\t\t\t<SecurityGroupId.n is_array=\"true\" option_tab=\"Options\">\n\t\t\t\t\t\t\t<SecurityGroupId input_type=\"text\" />\n\t\t\t\t\t\t</SecurityGroupId.n>\n\t\t\t\t\t\t<SecurityGroup.n is_array=\"true\">\n\t\t\t\t\t\t\t<SecurityGroup input_type=\"text\">[[sg]]</SecurityGroup>\n\t\t\t\t\t\t</SecurityGroup.n>\n\t\t\t\t\t\t<Placement option_tab=\"Options\">\n\t\t\t\t\t\t\t<AvailabilityZone input_type=\"text\" />\n\t\t\t\t\t\t\t<GroupName input_type=\"text\" />\n\t\t\t\t\t\t\t<Tenancy input_type=\"text\" />\n\t\t\t\t\t\t</Placement>\n\t\t\t\t\t\t<KernelId input_type=\"text\" option_tab=\"Options\" />\n\t\t\t\t\t\t<RamdiskId input_type=\"text\" option_tab=\"Options\" />\n\t\t\t\t\t\t<BlockDeviceMapping.n is_array=\"true\" option_tab=\"Options\">\n\t\t\t\t\t\t\t<BlockDeviceMapping>\n\t\t\t\t\t\t\t\t<DeviceName input_type=\"text\" />\n\t\t\t\t\t\t\t\t<NoDevice input_type=\"text\" />\n\t\t\t\t\t\t\t\t<VirtualName input_type=\"text\" />\n\t\t\t\t\t\t\t\t<Ebs>\n\t\t\t\t\t\t\t\t\t<SnapshotId input_type=\"text\" />\n\t\t\t\t\t\t\t\t\t<VolumeSize input_type=\"text\" />\n\t\t\t\t\t\t\t\t\t<DeleteOnTermination input_type=\"text\" />\n\t\t\t\t\t\t\t\t</Ebs>\n\t\t\t\t\t\t\t</BlockDeviceMapping>\n\t\t\t\t\t\t</BlockDeviceMapping.n>\n\t\t\t\t\t\t<Monitoring option_tab=\"Options\">\n\t\t\t\t\t\t\t<Enabled input_type=\"text\" />\n\t\t\t\t\t\t</Monitoring>\n\t\t\t\t\t\t<SubnetId input_type=\"text\" option_tab=\"Options\" />\n\t\t\t\t\t\t<DisableApiTermination input_type=\"text\" option_tab=\"Options\" />\n\t\t\t\t\t\t<InstanceInitiatedShutdownBehavior input_type=\"text\" option_tab=\"Options\" />\n\t\t\t\t\t\t<PrivateIpAddress input_type=\"text\" option_tab=\"Options\" />\n\t\t\t\t\t\t<ClientToken input_type=\"text\" option_tab=\"Options\" />\n\t\t\t\t\t\t<AddressingType input_type=\"text\" option_tab=\"Options\" />\n\t\t\t\t\t</function>",
                    "IsValid": true,
                    "Locked": false,
                    "Order": 3,
                    "OutputColumnDelimiter": 0,
                    "OutputParseType": 0,
                    "OutputRowDelimiter": 0,
                    "ValueSnip": null,
                    "XPathPrefix": ""
                },
                {
                    "Codeblock": "MAIN",
                    "Commented": false,
                    "Description": "extract the instance id from the result xml",
                    "FunctionName": "set_variable",
                    "FunctionXML": "<function name=\"set_variable\">\n                            <variables label=\"Variables\">\n                                <variable label=\"Variable\">\n                                    <name input_type=\"text\" label=\"Name\">instance</name>\n                                    <value input_type=\"text\" label=\"Value\">[[result.//instanceId]]</value>\n                                    <modifier input_type=\"select\" label=\"Modifier\">DEFAULT</modifier>\n                                </variable>\n                            </variables>\n                        </function>",
                    "IsValid": true,
                    "Locked": false,
                    "Order": 4,
                    "OutputColumnDelimiter": 0,
                    "OutputParseType": 0,
                    "OutputRowDelimiter": 0,
                    "ValueSnip": null,
                    "XPathPrefix": ""
                },
                {
                    "Codeblock": "MAIN",
                    "Commented": false,
                    "Description": "register the instance id",
                    "FunctionName": "register_host_instance",
                    "FunctionXML": "<function extension=\"maestro.maestro\" name=\"register_host_instance\">\n                            <host_name input_type=\"text\" label=\"Hostname\">[[instance]]</host_name>\n                            <address input_type=\"text\" label=\"Address\">[[dnsname]]</address>\n                        </function>",
                    "IsValid": true,
                    "Locked": false,
                    "Order": 5,
                    "OutputColumnDelimiter": 0,
                    "OutputParseType": 0,
                    "OutputRowDelimiter": 0,
                    "ValueSnip": null,
                    "XPathPrefix": ""
                },
                {
                    "Codeblock": "MAIN",
                    "Commented": false,
                    "Description": "clear the result xml from memory",
                    "FunctionName": "clear_variable",
                    "FunctionXML": "<function name=\"clear_variable\">\n                            <variables label=\"Variables\">\n                                <variable label=\"Variable\">\n                                    <name input_type=\"text\" label=\"Name\">result</name>\n                                </variable>\n                            </variables>\n                        </function>",
                    "IsValid": true,
                    "Locked": false,
                    "Order": 6,
                    "OutputColumnDelimiter": 0,
                    "OutputParseType": 0,
                    "OutputRowDelimiter": 0,
                    "ValueSnip": null,
                    "XPathPrefix": ""
                },
                {
                    "Codeblock": "MAIN",
                    "Commented": false,
                    "Description": "call codeblock the waits until the instance is running",
                    "FunctionName": "codeblock",
                    "FunctionXML": "<function name=\"codeblock\" snip=\"codeblock\">\n\t\t\t\t\t<codeblock input_type=\"text\">wait_for_boot</codeblock>\n\t\t\t\t</function>",
                    "IsValid": true,
                    "Locked": false,
                    "Order": 7,
                    "OutputColumnDelimiter": 0,
                    "OutputParseType": 0,
                    "OutputRowDelimiter": 0,
                    "ValueSnip": "wait_for_boot",
                    "XPathPrefix": ""
                },
                {
                    "Codeblock": "MAIN",
                    "Commented": false,
                    "Description": "register the instance and address",
                    "FunctionName": "register_host_instance",
                    "FunctionXML": "<function extension=\"maestro.maestro\" name=\"register_host_instance\">\n                            <host_name input_type=\"text\" label=\"Hostname\">[[instance]]</host_name>\n                            <address input_type=\"text\" label=\"Address\">[[dnsname]]</address>\n                        </function>",
                    "IsValid": true,
                    "Locked": false,
                    "Order": 8,
                    "OutputColumnDelimiter": 0,
                    "OutputParseType": 0,
                    "OutputRowDelimiter": 0,
                    "ValueSnip": null,
                    "XPathPrefix": ""
                }
            ]
        },
        {
            "Name": "wait_for_boot",
            "Steps": [
                {
                    "Codeblock": "wait_for_boot",
                    "Commented": false,
                    "Description": "if we don't have an instance id, something is wrong",
                    "FunctionName": "if",
                    "FunctionXML": "<function name=\"if\">\n                            <tests>\n                                <test>\n                                    <eval>\"[[instance]]\" == \"\"</eval>\n                                    <action>\n                                        <function name=\"end\" snip=\"status\">\n                                            <status dataset=\"Completed|Error|Cancelled\" datasource=\"local\" input_type=\"dropdown\" label=\"Status\">Error</status>\n                                            <message class=\"w95pct\" input_type=\"textarea\" label=\"Message\" label_style=\"display: block;\" rows=\"3\">Instance variable not populated. Erroring</message>\n                                        </function>\n                                    </action>\n                                </test>\n                            </tests>\n                        </function>",
                    "IsValid": true,
                    "Locked": false,
                    "Order": 1,
                    "OutputColumnDelimiter": 0,
                    "OutputParseType": 0,
                    "OutputRowDelimiter": 0,
                    "ValueSnip": null,
                    "XPathPrefix": ""
                },
                {
                    "Codeblock": "wait_for_boot",
                    "Commented": false,
                    "Description": "set the loop parameters",
                    "FunctionName": "set_variable",
                    "FunctionXML": "<function name=\"set_variable\">\n                            <variables label=\"Variables\">\n                                <variable label=\"Variable\">\n                                    <name input_type=\"text\" label=\"Name\">num_tests</name>\n                                    <value input_type=\"text\" label=\"Value\">360</value>\n                                    <modifier input_type=\"select\" label=\"Modifier\">DEFAULT</modifier>\n                                </variable>\n                                <variable label=\"Variable\">\n                                    <name input_type=\"text\" label=\"Name\">sleep_secs</name>\n                                    <value input_type=\"text\" label=\"Value\">10</value>\n                                    <modifier input_type=\"select\" label=\"Modifier\">DEFAULT</modifier>\n                                </variable>\n                            </variables>\n                        </function>",
                    "IsValid": true,
                    "Locked": false,
                    "Order": 2,
                    "OutputColumnDelimiter": 0,
                    "OutputParseType": 0,
                    "OutputRowDelimiter": 0,
                    "ValueSnip": null,
                    "XPathPrefix": ""
                },
                {
                    "Codeblock": "wait_for_boot",
                    "Commented": false,
                    "Description": "loop for a certain number of times testing the status",
                    "FunctionName": "loop",
                    "FunctionXML": "<function name=\"loop\">\n                            <start input_type=\"text\">1</start>\n                            <counter input_type=\"text\">z</counter>\n                            <test input_type=\"select\">&lt;=</test>\n                            <compare_to input_type=\"text\">[[num_tests]]</compare_to>\n                            <increment input_type=\"text\">1</increment>\n                            <action>\n                                <function name=\"codeblock\" snip=\"codeblock\">\n                                    <codeblock input_type=\"text\">getinstancestatus</codeblock>\n                                </function>\n                            </action>\n                            <max input_type=\"text\" />\n                        </function>",
                    "IsValid": true,
                    "Locked": false,
                    "Order": 3,
                    "OutputColumnDelimiter": 0,
                    "OutputParseType": 0,
                    "OutputRowDelimiter": 0,
                    "ValueSnip": null,
                    "XPathPrefix": ""
                },
                {
                    "Codeblock": "wait_for_boot",
                    "Commented": false,
                    "Description": "at this point, if the instance is not running there is something wrong",
                    "FunctionName": "if",
                    "FunctionXML": "<function name=\"if\">\n                            <tests>\n                                <test>\n                                    <eval>\"[[state]]\" != \"running\"</eval>\n                                    <action>\n                                        <function name=\"end\" snip=\"status\">\n                                            <status dataset=\"Completed|Error|Cancelled\" datasource=\"local\" input_type=\"dropdown\" label=\"Status\">Error</status>\n                                            <message class=\"w95pct\" input_type=\"textarea\" label=\"Message\" label_style=\"display: block;\" rows=\"3\">instance [[instance]] is not running, state is [[state]], dnsname is [[dnsname]]</message>\n                                        </function>\n                                    </action>\n                                </test>\n                            </tests>\n                            <else input_type=\"text\">\n                                <function name=\"log_msg\" snip=\"message\">\n                                    <message class=\"w95pct\" input_type=\"textarea\" label=\"Log\" label_style=\"display: block;\" required=\"true\" rows=\"2\">instance [[instance]] is running, state is [[state]], dnsname is [[dnsname]]</message>\n                                </function>\n                            </else>\n                        </function>",
                    "IsValid": true,
                    "Locked": false,
                    "Order": 4,
                    "OutputColumnDelimiter": 0,
                    "OutputParseType": 0,
                    "OutputRowDelimiter": 0,
                    "ValueSnip": null,
                    "XPathPrefix": ""
                }
            ]
        }
    ],
    "ConcurrentInstances": "",
    "Description": "Creates instance in EC2",
    "IsDefaultVersion": true,
    "MaxVersion": 1.0,
    "Name": "Boot Instance",
    "NextMajorVersion": "2.000",
    "NextMinorVersion": "1.001",
    "NumberOfApprovedVersions": 0,
    "Parameters": "<parameters>\n            </parameters>",
    "QueueDepth": "",
    "Status": "Development",
    "UseConnectorSystem": false,
    "Version": 1.0
}
